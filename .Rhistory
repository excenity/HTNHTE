max_depth = 2:5,
eta = c(0.1, 0.05, 0.01))
xgboost.learners = SuperLearner::create.Learner("SL.xgboost", tune = tune, detailed_names = TRUE, name_prefix = "xgb")
# elastic net
enet = SuperLearner::create.Learner("SL.glmnet", detailed_names = T, tune = list(alpha = seq(0, 1, length.out = 5)))
# list libraries
SL.library.chosen = c("SL.mean", "SL.glm", "SL.glm.interaction", enet$names, xgboost.learners$names, RF.learners$names)
outcome = 'sbp_change'
result <- TMLE_analysis(
outcome = outcome,
patient_profile_list = patient_profile_list,
htn_med_list = htn_med_list
)
cont_var = c('sbp', 'ldl', 'age', 'bmi')
cutpoints = list(c(0, 150, 300),
c(0 ,100, 300),
c(0, 65, 150),
c(0, 30, 100))
executeStudy(
connectionDetails = connectionDetails,
cdmDatabaseSchema = 'htnhte',
cohortDatabaseSchema = 'htnhte',
cohortTable = 'htn_hte',
outputpath = '/Users/excenity/Documents/HSIP/Research/Dissertation Project/Results/results_081824',
generateCohorts = F,
extractingData = F,
runStatisticsAnalysis = F,
runTreatmentEffects = T,
htn_med_list = htn_med_list_default,
cont_var = cont_var,
cutpoints = cutpoints
)
if (!require(SuperLearner))
{
install.packages("SuperLearner")
}
library(HTNHTE)
library(DatabaseConnector)
library(SqlRender)
library(SuperLearner)
library(tidyverse)
# medication type list
htn_med_list_default = c('acei', 'arb', 'ccb', 'diuretic', 'ccb_combo', 'diuretic_combo')
##### PLEASE EDIT #####
connectionDetails = createConnectionDetails(
dbms = "postgresql",
server = 'localhost/HTN_OMOP',
user = 'postgres',
password = '741China@',
pathToDriver = '/Users/excenity/Library/R/jdbcDrivers'
)
executeStudy(
connectionDetails = connectionDetails,
cdmDatabaseSchema = 'htnhte',
cohortDatabaseSchema = 'htnhte',
cohortTable = 'htn_hte',
outputpath = '/Users/excenity/Documents/HSIP/Research/Dissertation Project/Results/results_081824',
generateCohorts = F,
extractingData = T,
runStatisticsAnalysis = F,
runTreatmentEffects = F,
cont_var = cont_var,
cutpoints = cutpoints
)
library(HTNHTE)
if (!require(SuperLearner))
{
install.packages("SuperLearner")
}
library(HTNHTE)
library(DatabaseConnector)
library(SqlRender)
library(SuperLearner)
library(tidyverse)
# medication type list
htn_med_list_default = c('acei', 'arb', 'ccb', 'diuretic', 'ccb_combo', 'diuretic_combo')
cont_var = c('sbp', 'ldl', 'age', 'bmi')
cutpoints = list(c(0, 150, 300),
c(0 ,100, 300),
c(0, 65, 150),
c(0, 30, 100))
executeStudy(
connectionDetails = connectionDetails,
cdmDatabaseSchema = 'htnhte',
cohortDatabaseSchema = 'htnhte',
cohortTable = 'htn_hte',
outputpath = '/Users/excenity/Documents/HSIP/Research/Dissertation Project/Results/results_081824',
generateCohorts = F,
extractingData = F,
runStatisticsAnalysis = F,
runTreatmentEffects = T,
htn_med_list = htn_med_list_default,
cont_var = cont_var,
cutpoints = cutpoints
)
source("~/Documents/HSIP/Research/Dissertation Project/Code/HTNHTE/R/execution.R", echo=TRUE)
library(HTNHTE)
cont_var = c('sbp', 'ldl', 'age', 'bmi')
cutpoints = list(c(0, 150, 300),
c(0 ,100, 300),
c(0, 65, 150),
c(0, 30, 100))
executeStudy(
connectionDetails = connectionDetails,
cdmDatabaseSchema = 'htnhte',
cohortDatabaseSchema = 'htnhte',
cohortTable = 'htn_hte',
outputpath = '/Users/excenity/Documents/HSIP/Research/Dissertation Project/Results/results_081824',
generateCohorts = F,
extractingData = F,
runStatisticsAnalysis = F,
runTreatmentEffects = T,
htn_med_list = htn_med_list_default,
cont_var = cont_var,
cutpoints = cutpoints
)
cont_var = c('sbp', 'ldl', 'age', 'bmi')
cutpoints = list(c(0, 150, 300),
c(0 ,100, 300),
c(0, 65, 150),
c(0, 30, 100))
executeStudy(
connectionDetails = connectionDetails,
cdmDatabaseSchema = 'htnhte',
cohortDatabaseSchema = 'htnhte',
cohortTable = 'htn_hte',
outputpath = '/Users/excenity/Documents/HSIP/Research/Dissertation Project/Results/results_081824',
generateCohorts = F,
extractingData = F,
runStatisticsAnalysis = F,
runTreatmentEffects = T,
htn_med_list = htn_med_list_default,
cont_var = cont_var,
cutpoints = cutpoints
)
if(!file.exists(file.path(outputpath, 'data.rds'))){
message('No data - please run with extractingData = T first')
} else{
df <- readRDS(file.path(outputpath, 'data.rds'))
# create patient profiles
df = createPatientProfiles(cont_var, cutpoints, df)
patient_profile_list = df %>% dplyr::distinct(patient_profiles)
# random forest
RF.learners = SuperLearner::create.Learner("SL.ranger", tune = list(mtry = 3, num.trees = 500))
# xgboost
tune = list(ntrees = c(5, 10, 15),
max_depth = 2:5,
eta = c(0.1, 0.05, 0.01))
xgboost.learners = SuperLearner::create.Learner("SL.xgboost", tune = tune, detailed_names = TRUE, name_prefix = "xgb")
# elastic net
enet = SuperLearner::create.Learner("SL.glmnet", detailed_names = T, tune = list(alpha = seq(0, 1, length.out = 5)))
# list libraries
SL.library.chosen = c("SL.mean", "SL.glm", "SL.glm.interaction", enet$names, xgboost.learners$names, RF.learners$names)
# TMLE Analysis for Main Outcomes
for(outcome in c('at_control_14090', 'at_control_13080','sbp_change')){
result <- TMLE_analysis(
outcome = outcome,
patient_profile_list = patient_profile_list,
htn_med_list = htn_med_list
)
if(!dir.exists(file.path(outputpath,'tmle_results_df'))){
dir.create(file.path(outputpath,'tmle_results_df'), recursive = T)
}
if(!dir.exists(file.path(outputpath,'tmle_plots'))){
dir.create(file.path(outputpath,'tmle_plots'), recursive = T)
}
write.csv(
x = result$tmleResultsDf,
file = file.path(outputpath,'tmle_results_df', paste0(outcome, '.csv')), row.names = F)
ggplot2::ggsave(
filename = file.path(outputpath,'tmle_plots', paste0(outcome, '.png')),
result$tmlePlot,
height = 16,
width = 30
)
}
# create patient profiles
df = createPatientProfiles(cont_var, cutpoints, df)
cont_var = c('sbp', 'ldl', 'age', 'bmi')
cutpoints = list(c(0, 150, 300),
c(0 ,100, 300),
c(0, 65, 150),
c(0, 30, 100))
executeStudy(
connectionDetails = connectionDetails,
cdmDatabaseSchema = 'htnhte',
cohortDatabaseSchema = 'htnhte',
cohortTable = 'htn_hte',
outputpath = '/Users/excenity/Documents/HSIP/Research/Dissertation Project/Results/results_081824',
generateCohorts = F,
extractingData = F,
runStatisticsAnalysis = F,
runTreatmentEffects = T,
htn_med_list = htn_med_list_default,
cont_var = cont_var,
cutpoints = cutpoints
)
if (!require(SuperLearner))
{
install.packages("SuperLearner")
}
library(HTNHTE)
library(DatabaseConnector)
library(SqlRender)
library(SuperLearner)
library(tidyverse)
# medication type list
htn_med_list = c('acei', 'arb', 'ccb', 'diuretic', 'ccb_combo', 'diuretic_combo')
file.path(outputpath, 'data.rds')
outputpath = '/Users/excenity/Documents/HSIP/Research/Dissertation Project/Results/results_081824'
cont_var = c('sbp', 'ldl', 'age', 'bmi')
cutpoints = list(c(0, 150, 300),
c(0 ,100, 300),
c(0, 65, 150),
c(0, 30, 100))
executeStudy(
connectionDetails = connectionDetails,
cdmDatabaseSchema = 'htnhte',
cohortDatabaseSchema = 'htnhte',
cohortTable = 'htn_hte',
outputpath = '/Users/excenity/Documents/HSIP/Research/Dissertation Project/Results/results_081824',
generateCohorts = F,
extractingData = F,
runStatisticsAnalysis = F,
runTreatmentEffects = T,
cont_var = cont_var,
cutpoints = cutpoints
)
file.path(outputpath, 'data.rds'))
file.path(outputpath, 'data.rds')
df <- readRDS(file.path(outputpath, 'data.rds'))
cont_var = c('sbp', 'ldl', 'age', 'bmi')
cutpoints = list(c(0, 150, 300),
c(0 ,100, 300),
c(0, 65, 150),
c(0, 30, 100))
executeStudy(
connectionDetails = connectionDetails,
cdmDatabaseSchema = 'htnhte',
cohortDatabaseSchema = 'htnhte',
cohortTable = 'htn_hte',
outputpath = '/Users/excenity/Documents/HSIP/Research/Dissertation Project/Results/results_081824',
generateCohorts = F,
extractingData = F,
runStatisticsAnalysis = F,
runTreatmentEffects = T,
cont_var = cont_var,
cutpoints = cutpoints
)
df <- readRDS(file.path(outputpath, 'data.rds'))
# create patient profiles
df = createPatientProfiles(cont_var, cutpoints, df)
patient_profile_list = df %>% dplyr::distinct(patient_profiles)
# random forest
RF.learners = SuperLearner::create.Learner("SL.ranger", tune = list(mtry = 3, num.trees = 500))
# xgboost
tune = list(ntrees = c(5, 10, 15),
max_depth = 2:5,
eta = c(0.1, 0.05, 0.01))
xgboost.learners = SuperLearner::create.Learner("SL.xgboost", tune = tune, detailed_names = TRUE, name_prefix = "xgb")
# elastic net
enet = SuperLearner::create.Learner("SL.glmnet", detailed_names = T, tune = list(alpha = seq(0, 1, length.out = 5)))
# list libraries
SL.library.chosen = c("SL.mean", "SL.glm", "SL.glm.interaction", enet$names, xgboost.learners$names, RF.learners$names)
result <- TMLE_analysis(
outcome = outcome,
patient_profile_list = patient_profile_list,
htn_med_list = htn_med_list
)
if (!require(SuperLearner))
{
install.packages("SuperLearner")
}
library(HTNHTE)
library(DatabaseConnector)
library(SqlRender)
library(SuperLearner)
library(tidyverse)
# medication type list
htn_med_list = c('acei', 'arb', 'ccb', 'diuretic', 'ccb_combo', 'diuretic_combo')
library(HTNHTE)
library(HTNHTE)
if (!require(SuperLearner))
{
install.packages("SuperLearner")
}
library(HTNHTE)
library(DatabaseConnector)
library(SqlRender)
library(SuperLearner)
library(tidyverse)
# medication type list
htn_med_list = c('acei', 'arb', 'ccb', 'diuretic', 'ccb_combo', 'diuretic_combo')
cont_var = c('sbp', 'ldl', 'age', 'bmi')
cutpoints = list(c(0, 150, 300),
c(0 ,100, 300),
c(0, 65, 150),
c(0, 30, 100))
executeStudy(
connectionDetails = connectionDetails,
cdmDatabaseSchema = 'htnhte',
cohortDatabaseSchema = 'htnhte',
cohortTable = 'htn_hte',
outputpath = '/Users/excenity/Documents/HSIP/Research/Dissertation Project/Results/results_081824',
generateCohorts = F,
extractingData = F,
runStatisticsAnalysis = F,
runTreatmentEffects = T,
cont_var = cont_var,
cutpoints = cutpoints
)
df <- readRDS(file.path(outputpath, 'data.rds'))
head(df)
head(df)
df <- readRDS(file.path(outputpath, 'data.rds'))
outputpath = '/Users/excenity/Documents/HSIP/Research/Dissertation Project/Results/results_081824'
df <- readRDS(file.path(outputpath, 'data.rds'))
head(df)
# create patient profiles
df = createPatientProfiles(cont_var, cutpoints, df)
patient_profile_list = df %>% dplyr::distinct(patient_profiles)
patient_profile_list
head(df)
cont_var = c('sbp', 'ldl', 'age', 'bmi')
cutpoints = list(c(0, 150, 300),
c(0 ,100, 300),
c(0, 65, 150),
c(0, 30, 100))
executeStudy(
connectionDetails = connectionDetails,
cdmDatabaseSchema = 'htnhte',
cohortDatabaseSchema = 'htnhte',
cohortTable = 'htn_hte',
outputpath = '/Users/excenity/Documents/HSIP/Research/Dissertation Project/Results/results_081824',
generateCohorts = F,
extractingData = F,
runStatisticsAnalysis = F,
runTreatmentEffects = T,
cont_var = cont_var,
cutpoints = cutpoints
)
library(HTNHTE)
if (!require(SuperLearner))
{
install.packages("SuperLearner")
}
library(HTNHTE)
library(DatabaseConnector)
library(SqlRender)
library(SuperLearner)
library(tidyverse)
# medication type list
htn_med_list = c('acei', 'arb', 'ccb', 'diuretic', 'ccb_combo', 'diuretic_combo')
if (!require(SuperLearner))
{
install.packages("SuperLearner")
}
library(HTNHTE)
library(DatabaseConnector)
library(SqlRender)
library(SuperLearner)
library(tidyverse)
# medication type list
htn_med_list = c('acei', 'arb', 'ccb', 'diuretic', 'ccb_combo', 'diuretic_combo')
cont_var = c('sbp', 'ldl', 'age', 'bmi')
cutpoints = list(c(0, 150, 300),
c(0 ,100, 300),
c(0, 65, 150),
c(0, 30, 100))
executeStudy(
connectionDetails = connectionDetails,
cdmDatabaseSchema = 'htnhte',
cohortDatabaseSchema = 'htnhte',
cohortTable = 'htn_hte',
outputpath = '/Users/excenity/Documents/HSIP/Research/Dissertation Project/Results/results_081824',
generateCohorts = F,
extractingData = F,
runStatisticsAnalysis = F,
runTreatmentEffects = T,
cont_var = cont_var,
cutpoints = cutpoints
)
outputpath = '/Users/excenity/Documents/HSIP/Research/Dissertation Project/Results/results_081824'
df <- readRDS(file.path(outputpath, 'data.rds'))
message(paste0('rows of data read:', nrow(df)))
# create patient profiles
df = createPatientProfiles(cont_var, cutpoints, df)
patient_profile_list = df %>% dplyr::distinct(patient_profiles)
# random forest
RF.learners = SuperLearner::create.Learner("SL.ranger", tune = list(mtry = 3, num.trees = 500))
# xgboost
tune = list(ntrees = c(5, 10, 15),
max_depth = 2:5,
eta = c(0.1, 0.05, 0.01))
xgboost.learners = SuperLearner::create.Learner("SL.xgboost", tune = tune, detailed_names = TRUE, name_prefix = "xgb")
# elastic net
enet = SuperLearner::create.Learner("SL.glmnet", detailed_names = T, tune = list(alpha = seq(0, 1, length.out = 5)))
# list libraries
SL.library.chosen = c("SL.mean", "SL.glm", "SL.glm.interaction", enet$names, xgboost.learners$names, RF.learners$names)
outcome = 'sbp_change'
result <- TMLE_analysis(
outcome = outcome,
patient_profile_list = patient_profile_list,
htn_med_list = htn_med_list
)
knitr::opts_chunk$set(echo = TRUE)
library(ggplot2)
library(tidyverse)
library(data.table)
df= fread('/Users/excenity/Documents/HSIP/Research/Dissertation Project/Results/results_081824/tmle_results_df/at_control_14090.csv')
head(df)
patient_profile_list = df %>% distinct(patient_profiles) %>% arrange()
View(patient_profile_list)
patient_profile_list$num = 1:nrow(patient_profile_list)
View(patient_profile_list)
patient_profile_list$vars = str_split(patient_profile_list$patient_profiles, '_')
View(patient_profile_list)
# create variables
patient_profile_list = patient_profile_list %>% mutate(sbp = vars[1])
patient_profile_list$vars[1]
patient_profile_list$vars[1][1]
patient_profile_list$vars[1,1]
patient_profile_list$vars[[1]]
patient_profile_list$vars[1][1]
patient_profile_list$vars[1][1][1]
c("(150,300]", "[0,100]", "[0,65]", "[0,30]")[1]
patient_profile_list$vars[1][[1]]
patient_profile_list$vars[1][[1]]
patient_profile_list$vars[1][[1]][[1]]
patient_profile_list$vars[1][1][[1]]
patient_profile_list$vars[1][[1]][[1]]
# create variables
patient_profile_list = patient_profile_list %>% mutate(sbp = vars[1][[1]][[1]],
chol = vars[1][[1]][[2]],
age = vars[1][[1]][[3]],
bmi = vars[1][[1]][[4]])
patient_profile_list$vars[1][[2]][[1]]
patient_profile_list$vars[2][[1]][[1]]
for (i in 1:nrow(patient_profile_list))
{
patient_profile_list[i, 'sbp'] = patient_profile_list$vars[i][[1]][[1]]
patient_profile_list[i, 'chol'] = patient_profile_list$vars[i][[1]][[2]]
patient_profile_list[i, 'age'] = patient_profile_list$vars[i][[1]][[3]]
patient_profile_list[i, 'bmi'] = patient_profile_list$vars[i][[1]][[4]]
}
View(patient_profile_list)
View(patient_profile_list)
View(df)
df = df %>% group_by(patient_profiles) %>% arrange(Q1_star_avg) %>% mutate(rank = row_number())
df = df %>% group_by(patient_profiles) %>% arrange(desc(Q1_star_avg)) %>% mutate(rank = row_number())
View(df)
knitr::opts_chunk$set(echo = TRUE)
library(ggplot2)
library(tidyverse)
library(data.table)
df= fread('/Users/excenity/Documents/HSIP/Research/Dissertation Project/Results/results_081824/tmle_results_df/at_control_14090.csv')
# set up patient profiles
patient_profile_list = df %>% distinct(patient_profiles) %>% arrange()
patient_profile_list$num = 1:nrow(patient_profile_list)
patient_profile_list$vars = str_split(patient_profile_list$patient_profiles, '_')
# create variables
for (i in 1:nrow(patient_profile_list))
{
patient_profile_list[i, 'sbp'] = patient_profile_list$vars[i][[1]][[1]]
patient_profile_list[i, 'chol'] = patient_profile_list$vars[i][[1]][[2]]
patient_profile_list[i, 'age'] = patient_profile_list$vars[i][[1]][[3]]
patient_profile_list[i, 'bmi'] = patient_profile_list$vars[i][[1]][[4]]
}
df = df %>% group_by(patient_profiles) %>% arrange(desc(Q1_star_avg)) %>% mutate(rank = row_number())
overlap_list = c()
check_ci_overlap = function(df)
{
overlap = df$Q1_star_lb[df$rank == 1] > max(df$Q1_star_ub)
return(overlap)
}
for (i in 1:nrow(patient_profile_list))
{
df_pp = df %>% filter(patient_profiles %in% patient_profile_list[i])
overlap = check_ci_overlap(df_pp)
overlap_list = c(overlap_list, overlap)
}
View(patient_profile_list)
View(patient_profile_list)
overlap_list
overlap_list = c()
check_ci_overlap = function(df)
{
overlap = df$Q1_star_lb[df$rank == 1] <= max(df$Q1_star_ub)
return(overlap)
}
for (i in 1:nrow(patient_profile_list))
{
df_pp = df %>% filter(patient_profiles %in% patient_profile_list[i])
overlap = check_ci_overlap(df_pp)
overlap_list = c(overlap_list, overlap)
}
overlap_list = c()
check_ci_overlap = function(df)
{
overlap = df$Q1_star_lb[df$rank == 1] <= max(df$Q1_star_ub[df$rank>1])
return(overlap)
}
for (i in 1:nrow(patient_profile_list))
{
df_pp = df %>% filter(patient_profiles %in% patient_profile_list[i])
overlap = check_ci_overlap(df_pp)
overlap_list = c(overlap_list, overlap)
}
overlap_list
patient_profile_list$overlap = overlap_list
View(patient_profile_list)
distinct
