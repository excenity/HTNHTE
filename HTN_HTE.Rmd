---
title: "HTN HTE Analysis"
author: "Jingzhi Kevin Yu"
date: "4/15/24"
output: html_document
---

```{r, setup}
if (!require(SuperLearner))
{
  install.packages("SuperLearner")
}

library(HTNHTE)
library(DatabaseConnector)
library(SqlRender)
library(SuperLearner)
library(tidyverse)

# medication type list
htn_med_list = c('acei', 'arb', 'ccb', 'diuretic', 'ccb_combo', 'diuretic_combo')
```

# Part 1
1. Cohort Extraction
2. Creating Analytic Dataset
3. Statistical Analysis Step 1, 2 

```{r}
##### PLEASE EDIT ##### 
connectionDetails = createConnectionDetails(
  dbms = "postgresql",
  server = 'localhost/HTN_OMOP',
  user = 'postgres',
  password = '741China@',
  pathToDriver = '/Users/excenity/Library/R/jdbcDrivers'
)


executeStudy(
    connectionDetails = connectionDetails,
    cdmDatabaseSchema = 'htnhte',
    cohortDatabaseSchema = 'htnhte',
    cohortTable = 'htn_hte',
    outputpath = '/Users/excenity/Documents/HSIP/Research/Dissertation Project/Results/results_081824',
    generateCohorts = F,
    extractingData = T,
    runStatisticsAnalysis = F,
    runTreatmentEffects = F,
    cont_var = cont_var,
    cutpoints = cutpoints
)
```


## -- STOP HERE AND REVIEW RESULTS OF STEP 2 -- ## 

## PART 2: Use targeted estimation to determine treatment effects of BP medications

# STEP 3: Targeted Maximum Likelihood Estimation (TMLE) of Medication Treatment Effects within Different Patient Populations
```{r}
cont_var = c('sbp', 'ldl', 'age', 'bmi')

cutpoints = list(c(0, 150, 300),
                 c(0 ,100, 300),
                 c(0, 65, 150),
                 c(0, 30, 100))


executeStudy(
    connectionDetails = connectionDetails,
    cdmDatabaseSchema = 'htnhte',
    cohortDatabaseSchema = 'htnhte',
    cohortTable = 'htn_hte',
    outputpath = '/Users/excenity/Documents/HSIP/Research/Dissertation Project/Results/results_081824',
    generateCohorts = F,
    extractingData = F,
    runStatisticsAnalysis = F,
    runTreatmentEffects = T,
    cont_var = cont_var,
    cutpoints = cutpoints
)
```
